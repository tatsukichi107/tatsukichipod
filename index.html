<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="TalisPod - Soul Doll LegendzËÇ≤Êàê„Ç∑„Éü„É•„É¨„Éº„Çø„Éº„ÄÇÁí∞Â¢É„ÇíÊìç‰Ωú„Åó„Å¶„É¨„Ç∏„Çß„É≥„Ç∫„ÇíËÇ≤„Å¶„ÄÅÈ≠îÁéã„Ç∏„É£„Éê„Ç¶„Ç©„ÉÉ„ÇØ„ÇíÂÄí„Åõ„ÄÇ">
    <title>TalisPod ‚Äì Soul Doll Legendz Trainer</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/app.css">
    <link rel="stylesheet" href="./css/battle.css">
</head>

<body>

    <div id="app">

        <!-- ===== HEADER ===== -->
        <header class="header">
            <div class="header-top">
                <div>
                    <span class="header-logo">TalisPod</span>
                    <span class="header-version">v1.01</span>
                </div>
                <button id="btnComeback" class="btn-comeback">üíé Comeback</button>
            </div>
            <div id="headerInfo" class="header-info" style="display:none;">
                <div class="header-stats-row">
                    <span>Saga:</span> <span id="headerSaga">‚Äî</span> |
                    <span id="headerSpeciesFull">‚Äî</span>
                </div>
                <div class="header-nickname-row">
                    <span>Name:</span> <span id="headerNickname">‚Äî</span>
                </div>
                <div class="header-hp-row">
                    <span class="header-hp-label">HP</span>
                    <div class="header-hp-bar-bg">
                        <div id="headerHPBar" class="header-hp-bar"></div>
                    </div>
                    <div id="headerHPText" class="header-hp-text">0 / 0</div>
                </div>
            </div>
        </header>

        <!-- ===== START VIEW ===== -->
        <div id="startView" style="display:flex;">
            <div class="start-title">TalisPod</div>
            <div class="start-subtitle">Soul Doll Legendz Trainer</div>

            <div class="start-card">
                <label for="inputSagaName">„Çµ„Éº„Ç¨Âêç / Saga Name</label>
                <input type="text" id="inputSagaName" placeholder="„ÅÇ„Å™„Åü„ÅÆ„Çµ„Éº„Ç¨Âêç„ÇíÂÖ•Âäõ..." maxlength="30" autocomplete="off">
            </div>

            <div class="start-card">
                <label for="inputSoulCode">Soul Doll „ÅÆË®òÊÜ∂ / Soul Code (Âæ©ÂÖÉÁî®)</label>
                <textarea id="inputSoulCode" placeholder="SOUL1:xxxxx...&#10;ÔºàÊñ∞Ë¶è„ÅÆÂ†¥Âêà„ÅØÁ©∫Ê¨Ñ„ÅßOKÔºâ"></textarea>
            </div>

            <div class="start-actions">
                <button id="btnCodeReborn" class="btn btn-primary btn-full">
                    <div>üìú „ÇΩ„Ç¶„É´„Éâ„Éº„É´„Åã„Çâ„É™„Éú„Éº„É≥„Åô„Çã</div>
                    <div style="font-size: 0.7rem; font-weight: 400; opacity: 0.8; margin-top: 2px;">Reborn from Memory
                    </div>
                </button>
                <button id="btnNewReborn" class="btn btn-secondary btn-full">
                    <div>üîÆ „ÇΩ„Ç¶„É´„Éâ„Éº„É´„ÇíÁô∫Ë¶ã„Åô„Çã</div>
                    <div style="font-size: 0.7rem; font-weight: 400; opacity: 0.6; margin-top: 2px;">Find a Soul Doll
                    </div>
                </button>
            </div>
        </div>

        <!-- ===== MAIN VIEW ===== -->
        <div id="mainView" style="display:none; flex-direction:column; flex:1; min-height:0;">

            <!-- Tab Content -->
            <div class="tab-content">

                <!-- HOME TAB -->
                <div id="tab-home" class="tab-pane active">
                    <div class="scene-wrapper">
                        <div id="scene" class="scene area-NEUTRAL">
                            <div id="sprite" class="sprite"></div>
                            <div id="growthAnimHome" class="growth-anim-layer"></div>
                            <button id="btnSearch" class="btn btn-search" style="display:none;">üîç „Çµ„Éº„ÉÅ / Search</button>
                        </div>
                    </div>

                    <div class="home-info">
                        <div class="info-row">
                            <div class="info-card">
                                <div class="info-label">ÁèæÂú®Âú∞ / Area</div>
                                <div id="homeAreaName" class="info-value">‚Äî</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥ / Rank</div>
                                <div id="homeRankName" class="info-value rank-neutral">OFF</div>
                            </div>
                        </div>

                        <div class="info-card-full">
                            <div class="info-label">ÊàêÈï∑„Éá„Éº„Çø / Growth Info</div>
                            <div class="growth-box">
                                <div class="timer-section">
                                    <span class="timer-label">Next Growth:</span>
                                    <span id="homeTimer" class="info-value"
                                        style="font-family: var(--font-mono); font-size: 1.3rem;">00:00</span>
                                </div>
                                <div id="costCounter" class="cost-counter"
                                    style="display:none; margin-top:4px; padding:4px 0; border-top:1px solid rgba(255,255,255,0.1); color:var(--text-accent); font-weight:800; font-size:0.8rem;">
                                    üõ°Ô∏è SILENCE: <span id="costTimer" style="font-family:var(--font-mono);">10:00</span>
                                </div>
                                <div class="growth-sub-label">Estimated Result (Next Growth)</div>
                                <div id="homeGrowthPreview" class="growth-preview">
                                    <span class="growth-tag">No Growth</span>
                                </div>
                                <div class="session-growth-divider"></div>
                                <div class="growth-sub-label">Session Cumulative Growth</div>
                                <div id="homeSessionGrowth" class="session-growth-box-mini">
                                    <div class="session-growth-empty">No growth this session</div>
                                </div>
                            </div>
                        </div>



                        <button id="btnNeutralReset" class="btn btn-secondary btn-full btn-neutral-reset"
                            style="display:none;">
                            üè† ÁÑ°Â±ûÊÄß„Å´Êàª„Åô / Set Neutral
                        </button>
                    </div>
                </div>

                <!-- ENV TAB -->
                <div id="tab-env" class="tab-pane">
                    <div class="env-section">
                        <div class="env-section-title">üå°Ô∏è Áí∞Â¢ÉË®≠ÂÆö / Environment Setup</div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="slider-label-text">Ê∏©Â∫¶ / Temperature</span>
                                <span id="tempValue" class="slider-value">0¬∞C</span>
                            </div>
                            <input type="range" id="tempSlider" min="0" max="20" value="10" step="1">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="slider-label-text">ÊπøÂ∫¶ / Humidity</span>
                                <span id="humValue" class="slider-value">50%</span>
                            </div>
                            <input type="range" id="humSlider" min="0" max="21" value="10" step="1">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span id="lightLabel" class="slider-label-text">ÂÖâÈáè / Light</span>
                            </div>
                            <div class="light-buttons">
                                <button class="light-btn" data-val="0">0 (Êöó)</button>
                                <button class="light-btn active" data-val="50">50</button>
                                <button class="light-btn" data-val="100">100 (Êòé)</button>
                            </div>

                        </div>

                        <div class="slider-group">
                            <div class="info-label">Áí∞Â¢É‰∫àÊ∏¨ / Prediction</div>
                            <div id="envPreviewArea" class="info-value"
                                style="font-size:1.1rem; font-weight:800; color:var(--text-accent);">ÁÑ°Â±ûÊÄß / Neutral
                            </div>
                        </div>

                        <div class="env-actions">
                            <button id="btnResetEnv" class="btn btn-secondary" style="flex:1;">üîÑ „É™„Çª„ÉÉ„Éà</button>
                            <button id="btnApplyEnv" class="btn btn-primary" style="flex:2;">‚ö° ÂÜíÈô∫„Å´Âá∫Áô∫ / Apply</button>
                        </div>
                    </div>
                </div>

                <!-- LEGENDZ TAB -->
                <div id="tab-legendz" class="tab-pane">
                    <div class="legendz-header">
                        <div id="ldzSpritePreview" class="legendz-sprite-preview">
                            <div id="growthAnimLdz" class="growth-anim-layer"></div>
                        </div>
                        <div class="legendz-meta">
                            <div id="ldzSpecies" class="legendz-species">‚Äî</div>
                            <div><span id="ldzAttrBadge" class="attr-badge neutral">‚Äî</span></div>
                            <div class="legendz-nickname-row">
                                <input type="text" id="ldzNicknameInput" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†..." maxlength="20">
                                <button id="btnNicknameApply" class="btn btn-sm btn-secondary">Â§âÊõ¥</button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card full-width">
                            <div class="stat-name">HP</div>
                            <div id="ldzHP" class="stat-value">400 / 400</div>
                            <div class="stat-bar-wrap">
                                <div id="ldzHPBar" class="stat-bar hp" style="width:100%;"></div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-name">„Éû„Éõ„Ç¶ / Magic</div>
                            <div id="ldzStat-magic" class="stat-value">60</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-name">„Ç´„Ç¶„É≥„Çø„Éº / Counter</div>
                            <div id="ldzStat-counter" class="stat-value">100</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-name">„ÉÄ„Ç≤„Ç≠ / Attack</div>
                            <div id="ldzStat-attack" class="stat-value">60</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-name">„Ç´„Ç§„Éï„ÇØ / Recover</div>
                            <div id="ldzStat-recover" class="stat-value">20</div>
                        </div>
                    </div>



                    <!-- Skill Slots -->
                    <div class="skills-section">
                        <div class="skills-title">üó°Ô∏è „Çπ„Ç≠„É´ / Skills (15 slots)</div>
                        <div id="ldzSkillSlots"></div>
                    </div>
                </div>

                <!-- CRYSTAL TAB -->
                <div id="tab-crystal" class="tab-pane">
                    <div class="env-section-title" style="margin-bottom:12px;">üíé „ÇØ„É™„Çπ„Çø„É´ / Crystals</div>
                    <div id="crystalList" class="crystal-groups-container">
                        <!-- Groups and Crystals will be injected here -->
                        <div class="crystal-empty">„ÇØ„É™„Çπ„Çø„É´„ÇíÊâÄÊåÅ„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì<br>No crystals yet</div>
                    </div>
                </div>

            </div>

            <!-- Tab Navigation -->
            <nav class="tab-nav">
                <button id="tabBtn-home" onclick="switchTab('home')" class="active">
                    <div class="tab-icon">üè†</div>Home
                </button>
                <button id="tabBtn-env" onclick="switchTab('env')">
                    <div class="tab-icon">üåç</div>Env
                </button>
                <button id="tabBtn-legendz" onclick="switchTab('legendz')">
                    <div class="tab-icon">üêâ</div>Legendz
                </button>
                <button id="tabBtn-crystal" onclick="switchTab('crystal')">
                    <div class="tab-icon">üíé</div>Crystal
                </button>
            </nav>

        </div><!-- /mainView -->

    </div><!-- /app -->

    <!-- ===== MODALS ===== -->

    <!-- Notice Modal -->
    <div id="noticeModal" class="modal-overlay">
        <div class="modal">
            <div id="noticeModalTitle" class="modal-title">„ÅäÁü•„Çâ„Åõ</div>
            <div class="modal-body">
                <p id="noticeModalMsg"></p>
            </div>
            <div class="modal-actions">
                <button id="noticeModalOk" class="btn btn-primary btn-full">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal">
            <div id="confirmModalTitle" class="modal-title">Á¢∫Ë™ç</div>
            <div class="modal-body">
                <p id="confirmModalMsg"></p>
            </div>
            <div class="modal-actions">
                <button id="confirmYes" class="btn btn-primary" style="flex:1;">YES</button>
                <button id="confirmNo" class="btn btn-secondary" style="flex:1;">NO</button>
            </div>
        </div>
    </div>

    <!-- Comeback Modal -->
    <div id="comebackModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üíé Soul Doll „ÅÆË®òÊÜ∂ / Soul Code</div>
            <div id="comebackSaga" class="mb-8" style="font-size:0.8rem; color:var(--text-secondary);"></div>
            <div class="modal-body">
                <textarea id="comebackCode" readonly></textarea>
            </div>
            <div class="modal-actions-list">
                <button id="btnComebackCopy" class="btn btn-primary btn-full">üìã „Ç≥„Éî„Éº / Copy</button>
                <button id="btnComebackReborn" class="btn btn-danger btn-full">üîÑ Comeback</button>
                <button id="btnComebackClose" class="btn btn-secondary btn-full">‚Üê Êàª„Çã / Back</button>
            </div>
        </div>
    </div>

    <!-- Crystal Action Modal -->
    <div id="crystalActionModal" class="modal-overlay">
        <div class="modal action-modal">
            <div id="caTitle" class="modal-title">„ÇØ„É™„Çπ„Çø„É´Âêç</div>
            <div class="modal-body">
                <div id="caDesc" class="mb-8" style="font-size:0.85rem; color:var(--text-secondary);">Ë™¨ÊòéÊñá...</div>
                <div id="caEffect" class="mb-16" style="font-size:0.9rem; font-weight:700; color:var(--accent);">ÂäπÊûú...
                </div>
            </div>
            <div class="modal-actions-list">
                <button id="btnCaView" class="btn btn-secondary btn-full">Ë¶ã„Çã / View</button>
                <button id="btnCaUse" class="btn btn-primary btn-full">‰ΩøÁî®„Åô„Çã / Use</button>
                <button id="btnCaLearn" class="btn btn-accent btn-full">Ë¶ö„Åà„Çã / Learn</button>
                <button id="btnCaCancel" class="btn btn-secondary btn-full">„Ç≠„É£„É≥„Çª„É´ / Cancel</button>
            </div>
        </div>
    </div>

    <!-- Skill Slot Picker Modal -->
    <div id="skillSlotPickerModal" class="modal-overlay">
        <div class="modal picker-modal">
            <div class="modal-title">„Çπ„É≠„ÉÉ„Éà„ÇíÈÅ∏Êäû / Pick Slot</div>
            <div class="modal-body" style="max-height: 50vh; overflow-y: auto;">
                <p style="font-size:0.8rem; margin-bottom:12px; color:var(--text-secondary);">‰∏äÊõ∏„Åç„Åô„Çã„Çπ„Ç≠„É´„Çπ„É≠„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                <div id="skillSlotList" class="slot-picker-grid"></div>
            </div>
            <div class="modal-actions mt-16">
                <button id="btnSlotPickerCancel" class="btn btn-secondary btn-full">„Ç≠„É£„É≥„Çª„É´ / Cancel</button>
            </div>
        </div>
    </div>

    <!-- Legendz Preview Modal -->
    <div id="ldzPreviewModal" class="modal-overlay">
        <div id="ldzPreviewClose" class="modal-close-area"></div>
        <div class="modal preview-modal">
            <div id="ldzPreviewSprite" class="preview-sprite-large"></div>
            <div id="ldzPreviewDesc" class="preview-desc"></div>
            <div class="modal-actions mt-16">
                <button id="btnLdzPreviewClose" class="btn btn-secondary btn-full">Èñâ„Åò„Çã / Close</button>
            </div>
        </div>
    </div>

    <!-- Battle Modal (v0.9 Strategic) -->
    <div id="battleModal" class="modal-overlay">
        <div class="modal battle-view-modal">

            <!-- Layer 1: Intro -->
            <div id="battleIntroLayer" class="battle-intro-layer" style="display:none;">
                <div class="intro-bg-flash"></div>
                <div class="intro-text">ENEMY APPEARED</div>
            </div>

            <!-- Layer 2: Main Battle Scene -->
            <div id="battleMainLayer" class="battle-main-layer">
                <div id="battleTitle" class="modal-title">ROUND 1/5</div>

                <div class="battle-arena">
                    <div id="battleArenaFX" class="battle-arena-fx"></div>
                    <div id="counterFlashLayer" class="counter-flash-layer">COUNTER!!</div>
                    <!-- Player side (LEFT) -->
                    <div class="battle-unit player">
                        <div id="playerSprite" class="battle-sprite"></div>
                    </div>

                    <!-- Enemy side (RIGHT) -->
                    <div class="battle-unit enemy">
                        <div id="enemySprite" class="battle-sprite"></div>
                        <div class="unit-info">
                            <div id="enemyName" class="unit-name">ENEMY</div>
                            <div class="unit-hp-bar-bg">
                                <div id="enemyHPBar" class="unit-hp-bar" style="width: 100%;"></div>
                            </div>
                            <div id="enemyHPText" class="unit-hp-val">100/100</div>
                        </div>
                    </div>
                </div>

                <div id="battleLog" class="battle-log">
                    <div id="battleMsg">...</div>
                </div>
            </div>

            <!-- Layer 3: Skill Selection -->
            <div id="battleSelectionLayer" class="battle-selection-layer" style="display:none;">
                <div class="selection-header">
                    <div class="selection-top-row">
                        <div id="selectionRoundInfo" class="round-info">ROUND 1/5: SET 3 SKILLS (3„Å§„ÅÆ„ÉØ„Ç∂„ÇíÈÅ∏Êäû)</div>
                        <div id="selectionTimer" class="selection-timer">30</div>
                    </div>
                    <div class="selection-slots">
                        <div class="slot-item"><span id="slot0">‚Äî</span></div>
                        <div class="slot-item"><span id="slot1">‚Äî</span></div>
                        <div class="slot-item"><span id="slot2">‚Äî</span></div>
                    </div>
                </div>
                <div id="battleSkillGrid" class="battle-selection-grid">
                    <!-- 15 Skills will be injected here -->
                </div>
                <div class="btn-confirm-wrapper">
                    <button id="btnConfirmActions" class="btn btn-primary btn-full" disabled>Ê±∫ÂÆö / CONFIRM</button>
                </div>
            </div>

            <!-- Layer 4: Result/Reward -->
            <div id="battleResultLayer" class="battle-result-overlay" style="display:none;">
                <div id="battleResultHeader" class="result-text">VICTORY!</div>

                <div id="crystalRewardScene" class="crystal-reward-scene" style="display:none;">
                    <div class="crystal-prism-container">
                        <div class="crystal-prism"></div>
                    </div>
                    <div id="rewardText" class="reward-msg">„ÄêÔΩû„ÅÆ„Ç´„Ç±„É©„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ„Äë</div>
                </div>

                <div id="defeatPenaltyBox" class="defeat-penalty" style="display:none;">
                    <div style="color:var(--danger); font-weight:800; margin-bottom:8px;">DEFEAT... (ÊïóÂåó)</div>
                    <div style="font-size:0.8rem; opacity:0.8;">
                        „ÉÄ„É°„Éº„Ç∏ËìÑÁ©ç„ÄÅÂèä„Å≥Áí∞Â¢É„ÅåÁÑ°Â±ûÊÄß„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇ<br>
                        Damage accumulated. Environment reset to neutral.
                    </div>
                </div>

                <button id="btnBattleClose" class="btn btn-primary btn-full mt-16">Êàª„Çã / Return</button>
            </div>
        </div>
    </div>

    <!-- Adventure Overlay -->
    <div id="adventureOverlay" class="adventure-overlay">
        <div id="adventureTextJp" class="adventure-text">ÂÜíÈô∫ÂÖà„Å∏ÁßªÂãï‰∏≠...</div>
        <div id="adventureTextEn" class="adventure-text" style="font-size:0.9rem;">Travelling to destination...</div>
        <div class="adventure-dots">
            <span></span><span></span><span></span>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- ===== SCRIPTS (load order matters!) ===== -->
    <script src="./js/state.js"></script>
    <script src="./js/areaMap.js"></script>
    <script src="./js/areaResolver.js"></script>
    <script src="./data/LegendzData.js"></script>
    <script src="./data/EnemyLegendz.js"></script>
    <script src="./data/SkillData.js"></script>
    <script src="./data/CrystalData.js"></script>
    <script src="./js/spriteGen.js"></script>
    <script src="./js/game.js"></script>
    <script src="./js/battle.js"></script>
    <script src="./js/app.js"></script>

</body>

</html>