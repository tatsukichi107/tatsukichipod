/* =========================================================
 * css/app.css  (v0.76 UI安定版)
 * - スプライト切り抜き復旧（overflow hidden）
 * - 環境スライダー：大きめ＆中央揃え（PC/スマホ共通）
 * - カムバックモーダル：activeで表示/非表示、タップ吸い込み対策
 * ========================================================= */

:root{
  --bg: #0f1116;
  --panel: #171a22;
  --panel2:#1f2430;
  --text:#eef2ff;
  --muted:#aab3cc;

  /* 環境属性カラー（やや派手め） */
  --volcano:#ff6b6b;
  --tornado:#f5f7ff;
  --earthquake:#5ee08b;
  --storm:#55b8ff;

  --shadow: 0 8px 30px rgba(0,0,0,.35);
  --radius: 14px;
  --tabH: 62px;
}

/* ===== base ===== */
*{ box-sizing: border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
  background: var(--bg);
  color: var(--text);
}

a{ color:inherit; }

button{
  border:0;
  border-radius: 12px;
  padding: 12px 14px;
  font-weight: 700;
  background: #2a3150;
  color: var(--text);
}
button:active{ transform: translateY(1px); }
button:disabled{ opacity:.5; }

input, textarea{
  font-family: inherit;
  color: var(--text);
}

/* iPhoneのテキスト入力ズーム対策（16px以上） */
input[type="text"], textarea{
  font-size: 16px;
}

/* ===== views ===== */
.view{
  display:none;
  min-height: 100vh;
  padding-bottom: calc(var(--tabH) + 14px);
}
.view.active{ display:block; }

.container{
  max-width: 920px;
  margin: 0 auto;
  padding: 14px 14px 0;
}

/* ===== header (固定) ===== */
.header{
  position: sticky;
  top: 0;
  z-index: 40;
  background: rgba(15,17,22,.92);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid rgba(255,255,255,.06);
}
.header-inner{
  max-width: 920px;
  margin: 0 auto;
  padding: 10px 14px 12px;
}
.header-title{
  font-weight: 900;
  letter-spacing: .06em;
  font-size: 20px;
  margin-bottom: 6px;
}
.header-lines{
  display: grid;
  gap: 2px;
  font-size: 13px;
  color: var(--muted);
}
.header-lines .line{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ===== start view ===== */
.start-card{
  background: var(--panel);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}
.start-card h2{
  margin: 0 0 10px;
  font-size: 16px;
}
.field{
  display: grid;
  gap: 8px;
  margin: 10px 0 14px;
}
.field label{
  font-size: 13px;
  color: var(--muted);
}
.field input[type="text"], .field textarea{
  width: 100%;
  background: var(--panel2);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  padding: 12px 12px;
}
.field textarea{ min-height: 90px; resize: vertical; }

.start-actions{
  display: grid;
  gap: 10px;
}
.start-actions button{
  width: 100%;
}

/* ===== tabs ===== */
.tabs{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: var(--tabH);
  z-index: 60;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  background: rgba(15,17,22,.96);
  border-top: 1px solid rgba(255,255,255,.06);
  backdrop-filter: blur(8px);
}
.tab-btn{
  appearance: none;
  border: 0;
  background: transparent;
  color: var(--muted);
  font-weight: 800;
  padding: 8px 6px 10px;
  display: grid;
  gap: 4px;
  align-content: center;
  justify-items: center;
}
.tab-btn .ico{
  font-size: 18px;
  line-height: 1;
}
.tab-btn.active{
  color: var(--text);
}
.tab-btn.active .dot{
  width: 6px;
  height: 6px;
  border-radius: 99px;
  background: #8bb6ff;
}

/* tab panels */
.tab-content{
  display:none;
}
.tab-content.active{ display:block; }

/* ===== home scene ===== */
.scene{
  margin-top: 14px;
  background: var(--panel);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

/* 属性背景（少し派手めに） */
.scene.attr-none{ background: var(--panel); }
.scene.attr-volcano{ background: linear-gradient(135deg, rgba(255,107,107,.32), rgba(23,26,34,.92)); }
.scene.attr-tornado{ background: linear-gradient(135deg, rgba(245,247,255,.22), rgba(23,26,34,.92)); }
.scene.attr-earthquake{ background: linear-gradient(135deg, rgba(94,224,139,.26), rgba(23,26,34,.92)); }
.scene.attr-storm{ background: linear-gradient(135deg, rgba(85,184,255,.26), rgba(23,26,34,.92)); }

.home-top{
  display: grid;
  gap: 8px;
}
.kv{
  display: grid;
  gap: 6px;
  font-size: 13px;
  color: var(--muted);
}
.kv strong{ color: var(--text); }

.home-actions{
  display: grid;
  gap: 10px;
  margin-top: 12px;
}
.home-actions button{ width: 100%; }

/* ===== sprite viewport (最重要：切り抜き復旧) ===== */
#spriteViewport{
  position: relative;       /* ★必須 */
  overflow: hidden;         /* ★必須：ここが無いとシート全体が見える */
  display: block;           /* 念のため */
  margin: 14px auto 10px;
  border-radius: 14px;
  /* width/height はJSで設定されるが、無い時でも暴れないように最小 */
  min-width: 72px;
  min-height: 96px;
}
#spriteSheetLayer{
  position: absolute;       /* ★必須 */
  left: 0;
  top: 0;
  width: 288px;             /* JSでも設定される */
  height: 192px;            /* JSでも設定される */
  image-rendering: pixelated;
}
#spriteFxLayer{
  position: absolute;
  left: 0;
  top: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
}

/* 音符 */
.fx-note-only{
  position: absolute;
  font-size: 28px;
  text-shadow: 0 2px 10px rgba(0,0,0,.35);
  animation: floatNote 1.2s ease-in-out infinite;
}
@keyframes floatNote{
  0%{ transform: translate(-50%,0); opacity: .9; }
  50%{ transform: translate(-50%,-10px); opacity: 1; }
  100%{ transform: translate(-50%,0); opacity: .9; }
}

/* 超ベストの派手エフェクト：画面全体 */
.scene.superbest-burst::before{
  content:"";
  position: absolute;
  inset:-30%;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,.28), transparent 40%),
    radial-gradient(circle at 70% 20%, rgba(85,184,255,.22), transparent 45%),
    radial-gradient(circle at 40% 80%, rgba(94,224,139,.18), transparent 45%),
    radial-gradient(circle at 80% 70%, rgba(255,107,107,.18), transparent 45%);
  filter: blur(2px);
  animation: burst 1.4s ease-in-out infinite;
  pointer-events: none;
}
@keyframes burst{
  0%{ opacity:.55; transform: scale(1); }
  50%{ opacity:.85; transform: scale(1.03); }
  100%{ opacity:.55; transform: scale(1); }
}
.superbest-particle{
  position: absolute;
  font-size: 22px;
  pointer-events: none;
  text-shadow: 0 2px 10px rgba(0,0,0,.25);
  animation: pop 1.7s ease-out forwards;
}
@keyframes pop{
  0%{ transform: translateY(0) scale(.9); opacity: 0; }
  15%{ opacity: 1; }
  100%{ transform: translateY(-24px) scale(1.15); opacity: 0; }
}

/* ===== environment tab ===== */
.panel{
  margin-top: 14px;
  background: var(--panel);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow);
}

.env-grid{
  display: grid;
  gap: 14px;
  justify-items: center; /* ★中央揃え（全体） */
}

.env-row{
  width: 100%;
  max-width: 720px;
  display: grid;
  gap: 8px;
  justify-items: center; /* ★中央揃え */
}

.env-row .label{
  width: 100%;
  max-width: 520px;
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 10px;
  color: var(--muted);
  font-size: 13px;
}
.env-row .label strong{ color: var(--text); }

.env-row .range-wrap{
  width: 100%;
  max-width: 520px;
  display: flex;
  justify-content: center;
  align-items: center;
}

input[type="range"]{
  width: 100%;
  max-width: 520px;
  /* “2倍くらい”の体感に近づける */
  transform: scaleY(1.8);
  transform-origin: center;
  margin: 8px 0;
}

/* 無属性ボタン：スマホ幅は上（導線対策）、それ以外は右寄せ */
.env-actions{
  width: 100%;
  max-width: 720px;
  display: grid;
  gap: 10px;
  justify-items: center;
}
.env-actions .row{
  width: 100%;
  max-width: 520px;
  display: flex;
  justify-content: flex-end; /* PCは右側に */
  gap: 10px;
}
.env-actions button{
  width: auto;
  min-width: 160px;
}

@media (max-width: 520px){
  .env-actions .row{
    flex-direction: column;
    align-items: stretch;
  }
  .env-actions button{
    width: 100%;
    min-width: 0;
  }
}

/* 予想環境 */
.env-preview{
  width: 100%;
  max-width: 520px;
  padding: 10px 12px;
  border-radius: 12px;
  background: var(--panel2);
  border: 1px solid rgba(255,255,255,.08);
  color: var(--muted);
  font-size: 13px;
}
.env-preview strong{ color: var(--text); }

/* 冒険オーバーレイ */
.adventure-overlay{
  position: absolute;
  inset: 0;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  letter-spacing: .12em;
  background: rgba(0,0,0,.55);
  z-index: 30;
}

/* ===== legendz tab ===== */
.legendz-grid{
  display: grid;
  gap: 12px;
}
.row-kv{
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
}
.kvline{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  color: var(--muted);
  font-size: 13px;
}
.kvline strong{ color: var(--text); }

.nick-edit{
  display: grid;
  gap: 8px;
  margin-top: 10px;
}
.nick-edit input[type="text"]{
  width: 100%;
  background: var(--panel2);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  padding: 12px 12px;
}
.nick-edit button{ width: 100%; }

/* ===== crystal tab ===== */
.crystal-box{
  display: grid;
  gap: 10px;
  color: var(--muted);
}
.crystal-box div{
  background: var(--panel2);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  padding: 10px 12px;
}

/* ===== modal (超重要：active切替) ===== */
.modal-backdrop{
  position: fixed;
  inset: 0;
  display: none;            /* ★通常は非表示 */
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: rgba(0,0,0,.55);
  z-index: 200;
}
.modal-backdrop.active{
  display: flex;            /* ★activeで表示 */
}

.modal{
  width: min(640px, 92vw);
  background: var(--panel);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 16px;
  box-shadow: var(--shadow);
  padding: 14px;
}

.modal-title{
  font-weight: 900;
  letter-spacing: .06em;
  margin-bottom: 10px;
}

.modal-code{
  width: 100%;
  min-height: 140px;
  background: var(--panel2);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  padding: 12px 12px;
  resize: vertical;
}

.modal-actions{
  display: grid;
  gap: 10px;
  margin-top: 12px;
}
.modal-actions button{
  width: 100%;
}

/* ===== safe area for iOS bottom bar ===== */
@supports (padding: env(safe-area-inset-bottom)) {
  .tabs{
    padding-bottom: env(safe-area-inset-bottom);
    height: calc(var(--tabH) + env(safe-area-inset-bottom));
  }
  .view{
    padding-bottom: calc(var(--tabH) + env(safe-area-inset-bottom) + 14px);
  }
}
